// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  wallet            String    @unique
  emailVerified     Boolean   @default(false)
  walletVerified    Boolean   @default(false)
  kycStatus         String    @default("unverified")
  kycProvider       String?
  kycCompletedAt    DateTime?
  userType          String
  displayName       String?
  avatarUrl         String?
  bio               String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  deletedAt         DateTime?
  
  bounties          Bounty[]           @relation("BrandBounties")
  videos            Video[]            @relation("CreatorVideos")
  approvedVideos    Video[]            @relation("ApprovedVideos")
  milestoneClaims   MilestoneClaim[]
  emailVerifications EmailVerification[]
  adminActions      AdminAction[]
  approvalDecisions ApprovalQueue[]    @relation("AdminDecisions")
  
  @@index([email])
  @@index([wallet])
  @@index([userType])
  @@map("users")
}

model Bounty {
  id                      Int       @id @default(autoincrement())
  contractAddress         String    @unique
  assetId                 Int
  assetPrecompileAddress  String
  brandId                 String
  title                   String
  description             String?
  requirements            String?
  contentGuidelines       String?
  deadline                DateTime
  maxVideos               Int
  minDurationSeconds      Int?
  maxDurationSeconds      Int?
  status                  String    @default("active")
  totalDeposit            Decimal   @db.Decimal(18, 6)
  remainingFunds          Decimal   @db.Decimal(18, 6)
  totalPaid               Decimal   @default(0) @db.Decimal(18, 6)
  videoCount              Int       @default(0)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  activatedAt             DateTime?
  completedAt             DateTime?
  deletedAt               DateTime?
  
  brand                   User      @relation("BrandBounties", fields: [brandId], references: [id])
  milestones              Milestone[]
  videos                  Video[]
  platforms               BountyPlatform[]
  milestoneClaims         MilestoneClaim[]
  
  @@index([brandId])
  @@index([status])
  @@index([deadline])
  @@map("bounties")
}

model BountyPlatform {
  id        Int      @id @default(autoincrement())
  bountyId  Int
  platform  String
  createdAt DateTime @default(now())
  
  bounty    Bounty   @relation(fields: [bountyId], references: [id], onDelete: Cascade)
  
  @@unique([bountyId, platform])
  @@map("bounty_platforms")
}

model Milestone {
  id              Int      @id @default(autoincrement())
  bountyId        Int
  viewsRequired   BigInt
  rewardAmount    Decimal  @db.Decimal(18, 6)
  milestoneOrder  Int
  createdAt       DateTime @default(now())
  
  bounty          Bounty   @relation(fields: [bountyId], references: [id], onDelete: Cascade)
  claims          MilestoneClaim[]
  analyses        VideoAnalysis[]
  approvalQueue   ApprovalQueue[]
  
  @@unique([bountyId, milestoneOrder])
  @@unique([bountyId, viewsRequired])
  @@index([bountyId])
  @@map("milestones")
}

model Video {
  id                Int       @id @default(autoincrement())
  bountyId          Int
  creatorId         String
  platform          String
  videoId           String
  videoUrl          String
  title             String?
  thumbnailUrl      String?
  description       String?
  durationSeconds   Int?
  publishedAt       DateTime?
  currentViews      BigInt    @default(0)
  lastChecked       DateTime?
  checkCount        Int       @default(0)
  approvalStatus    String    @default("pending")
  approvedAt        DateTime?
  approvedBy        String?
  rejectionReason   String?
  totalEarned       Decimal   @default(0) @db.Decimal(18, 6)
  milestonesClaimed Int       @default(0)
  registeredAt      DateTime  @default(now())
  completedAt       DateTime?
  
  bounty            Bounty    @relation(fields: [bountyId], references: [id])
  creator           User      @relation("CreatorVideos", fields: [creatorId], references: [id])
  approver          User?     @relation("ApprovedVideos", fields: [approvedBy], references: [id])
  milestoneClaims   MilestoneClaim[]
  analyses          VideoAnalysis[]
  approvalQueue     ApprovalQueue[]
  
  @@unique([bountyId, videoId])
  @@index([bountyId])
  @@index([creatorId])
  @@index([approvalStatus])
  @@map("videos")
}

model VideoAnalysis {
  id                       Int       @id @default(autoincrement())
  videoId                  Int
  milestoneId              Int
  transcription            String?
  transcriptionConfidence  Decimal?  @db.Decimal(3, 2)
  languageDetected         String?
  contentSummary           String?
  contentMatches           Boolean?
  matchConfidence          Decimal?  @db.Decimal(3, 2)
  topicsDetected           Json?
  isBot                    Boolean?
  botConfidence            Decimal?  @db.Decimal(3, 2)
  botSignals               Json?
  rating                   Int?
  ratingReasoning          String?
  overallConfidence        Decimal?  @db.Decimal(3, 2)
  aiModelResponse          Json?
  aiModelUsed              String?
  status                   String    @default("completed")
  processingTimeMs         Int?
  apiCostUsd               Decimal?  @db.Decimal(10, 6)
  analyzedAt               DateTime  @default(now())
  
  video                    Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  milestone                Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  approvalQueue            ApprovalQueue?
  
  @@unique([videoId, milestoneId])
  @@index([videoId])
  @@index([milestoneId])
  @@index([rating])
  @@map("video_analyses")
}

model ApprovalQueue {
  id             Int       @id @default(autoincrement())
  videoId        Int
  milestoneId    Int
  analysisId     Int?      @unique
  status         String    @default("pending")
  priority       Int       @default(0)
  decisionType   String?
  decidedBy      String?
  decisionReason String?
  decidedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  video          Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  milestone      Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  analysis       VideoAnalysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  decidedByUser  User?     @relation("AdminDecisions", fields: [decidedBy], references: [id])
  
  @@unique([videoId, milestoneId])
  @@index([status])
  @@index([priority])
  @@map("approval_queue")
}

model AdminAction {
  id         Int      @id @default(autoincrement())
  adminId    String
  actionType String
  entityType String
  entityId   Int
  reason     String?
  metadata   Json?
  createdAt  DateTime @default(now())
  
  admin      User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([actionType])
  @@map("admin_actions")
}

model MilestoneClaim {
  id             Int      @id @default(autoincrement())
  videoId        Int
  bountyId       Int
  creatorId      String
  milestoneId    Int
  viewsAtClaim   BigInt
  rewardAmount   Decimal  @db.Decimal(18, 6)
  platformFee    Decimal  @db.Decimal(18, 6)
  txHash         String
  blockNumber    BigInt?
  claimedAt      DateTime @default(now())
  
  video          Video    @relation(fields: [videoId], references: [id])
  bounty         Bounty   @relation(fields: [bountyId], references: [id])
  creator        User     @relation(fields: [creatorId], references: [id])
  milestone      Milestone @relation(fields: [milestoneId], references: [id])
  
  @@unique([videoId, milestoneId])
  @@index([bountyId])
  @@index([creatorId])
  @@map("milestone_claims")
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("email_verifications")
}
