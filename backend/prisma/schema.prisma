// schema.prisma - CamelCase WITH @map() to snake_case DB
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  wallet          String    @unique
  emailVerified   Boolean   @default(false) @map("email_verified")
  walletVerified  Boolean   @default(false) @map("wallet_verified")
  kycStatus       String    @default("unverified") @map("kyc_status")
  kycProvider     String?   @map("kyc_provider")
  kycCompletedAt  DateTime? @map("kyc_completed_at")
  userType        String    @map("user_type")
  displayName     String?   @map("display_name")
  avatarUrl       String?   @map("avatar_url")
  bio             String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")
  deletedAt       DateTime? @map("deleted_at")
  
  bounties            Bounty[]           @relation("BrandBounties")
  videos              Video[]            @relation("CreatorVideos")
  approvedVideos      Video[]            @relation("ApprovedVideos")
  milestoneClaims     MilestoneClaim[]
  emailVerifications  EmailVerification[]
  adminActions        AdminAction[]
  approvalDecisions   ApprovalQueue[]    @relation("AdminDecisions")
  
  @@index([email])
  @@index([wallet])
  @@index([userType])
  @@map("users")
}

model Bounty {
  id                      Int       @id @default(autoincrement())
  contractAddress         String    @unique @map("contract_address")
  assetId                 Int       @map("asset_id")
  assetPrecompileAddress  String    @map("asset_precompile_address")
  brandId                 String    @map("brand_id")
  title                   String
  description             String?
  requirements            String?
  contentGuidelines       String?   @map("content_guidelines")
  deadline                DateTime
  maxVideos               Int       @map("max_videos")
  minDurationSeconds      Int?      @map("min_duration_seconds")
  maxDurationSeconds      Int?      @map("max_duration_seconds")
  status                  String    @default("active")
  totalDeposit            Decimal   @db.Decimal(18, 6) @map("total_deposit")
  remainingFunds          Decimal   @db.Decimal(18, 6) @map("remaining_funds")
  totalPaid               Decimal   @default(0) @db.Decimal(18, 6) @map("total_paid")
  videoCount              Int       @default(0) @map("video_count")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  activatedAt             DateTime? @map("activated_at")
  completedAt             DateTime? @map("completed_at")
  deletedAt               DateTime? @map("deleted_at")
  
  brand            User             @relation("BrandBounties", fields: [brandId], references: [id])
  milestones       Milestone[]
  videos           Video[]
  platforms        BountyPlatform[]
  milestoneClaims  MilestoneClaim[]
  
  @@index([brandId])
  @@index([status])
  @@index([deadline])
  @@map("bounties")
}

model BountyPlatform {
  id        Int      @id @default(autoincrement())
  bountyId  Int      @map("bounty_id")
  platform  String
  createdAt DateTime @default(now()) @map("created_at")
  
  bounty Bounty @relation(fields: [bountyId], references: [id], onDelete: Cascade)
  
  @@unique([bountyId, platform])
  @@map("bounty_platforms")
}

model Milestone {
  id              Int      @id @default(autoincrement())
  bountyId        Int      @map("bounty_id")
  viewsRequired   BigInt   @map("views_required")
  rewardAmount    Decimal  @db.Decimal(18, 6) @map("reward_amount")
  milestoneOrder  Int      @map("milestone_order")
  createdAt       DateTime @default(now()) @map("created_at")
  
  bounty          Bounty          @relation(fields: [bountyId], references: [id], onDelete: Cascade)
  claims          MilestoneClaim[]
  analyses        VideoAnalysis[]
  approvalQueue   ApprovalQueue[]
  
  @@unique([bountyId, milestoneOrder])
  @@unique([bountyId, viewsRequired])
  @@index([bountyId])
  @@map("milestones")
}

model Video {
  id                Int       @id @default(autoincrement())
  bountyId          Int       @map("bounty_id")
  creatorId         String    @map("creator_id")
  platform          String
  videoId           String    @map("video_id")
  videoUrl          String    @map("video_url")
  title             String?
  thumbnailUrl      String?   @map("thumbnail_url")
  description       String?
  durationSeconds   Int?      @map("duration_seconds")
  publishedAt       DateTime? @map("published_at")
  currentViews      BigInt    @default(0) @map("current_views")
  lastChecked       DateTime? @map("last_checked")
  checkCount        Int       @default(0) @map("check_count")
  approvalStatus    String    @default("pending") @map("approval_status")
  approvedAt        DateTime? @map("approved_at")
  approvedBy        String?   @map("approved_by")
  rejectionReason   String?   @map("rejection_reason")
  totalEarned       Decimal   @default(0) @db.Decimal(18, 6) @map("total_earned")
  milestonesClaimed Int       @default(0) @map("milestones_claimed")
  registeredAt      DateTime  @default(now()) @map("registered_at")
  completedAt       DateTime? @map("completed_at")
  
  bounty            Bounty           @relation(fields: [bountyId], references: [id])
  creator           User             @relation("CreatorVideos", fields: [creatorId], references: [id])
  approver          User?            @relation("ApprovedVideos", fields: [approvedBy], references: [id])
  milestoneClaims   MilestoneClaim[]
  analyses          VideoAnalysis[]
  approvalQueue     ApprovalQueue[]
  
  @@unique([bountyId, videoId])
  @@index([bountyId])
  @@index([creatorId])
  @@index([approvalStatus])
  @@map("videos")
}

model VideoAnalysis {
  id                       Int       @id @default(autoincrement())
  videoId                  Int       @map("video_id")
  milestoneId              Int       @map("milestone_id")
  transcription            String?
  transcriptionConfidence  Decimal?  @db.Decimal(3, 2) @map("transcription_confidence")
  languageDetected         String?   @map("language_detected")
  contentSummary           String?   @map("content_summary")
  contentMatches           Boolean?  @map("content_matches")
  matchConfidence          Decimal?  @db.Decimal(3, 2) @map("match_confidence")
  topicsDetected           Json?     @map("topics_detected")
  isBot                    Boolean?  @map("is_bot")
  botConfidence            Decimal?  @db.Decimal(3, 2) @map("bot_confidence")
  botSignals               Json?     @map("bot_signals")
  rating                   Int?
  ratingReasoning          String?   @map("rating_reasoning")
  overallConfidence        Decimal?  @db.Decimal(3, 2) @map("overall_confidence")
  aiModelResponse          Json?     @map("ai_model_response")
  aiModelUsed              String?   @map("ai_model_used")
  status                   String    @default("completed")
  processingTimeMs         Int?      @map("processing_time_ms")
  apiCostUsd               Decimal?  @db.Decimal(10, 6) @map("api_cost_usd")
  analyzedAt               DateTime  @default(now()) @map("analyzed_at")
  
  video          Video          @relation(fields: [videoId], references: [id], onDelete: Cascade)
  milestone      Milestone      @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  approvalQueue  ApprovalQueue?
  
  @@unique([videoId, milestoneId])
  @@index([videoId])
  @@index([milestoneId])
  @@index([rating])
  @@map("video_analyses")
}

model ApprovalQueue {
  id              Int       @id @default(autoincrement())
  videoId         Int       @map("video_id")
  milestoneId     Int       @map("milestone_id")
  analysisId      Int?      @unique @map("analysis_id")
  status          String    @default("pending")
  priority        Int       @default(0)
  decisionType    String?   @map("decision_type")
  decidedBy       String?   @map("decided_by")
  decisionReason  String?   @map("decision_reason")
  decidedAt       DateTime? @map("decided_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  video           Video          @relation(fields: [videoId], references: [id], onDelete: Cascade)
  milestone       Milestone      @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  analysis        VideoAnalysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  decidedByUser   User?          @relation("AdminDecisions", fields: [decidedBy], references: [id])
  
  @@unique([videoId, milestoneId])
  @@index([status])
  @@index([priority])
  @@map("approval_queue")
}

model AdminAction {
  id          Int      @id @default(autoincrement())
  adminId     String   @map("admin_id")
  actionType  String   @map("action_type")
  entityType  String   @map("entity_type")
  entityId    Int      @map("entity_id")
  reason      String?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([actionType])
  @@map("admin_actions")
}

model MilestoneClaim {
  id            Int      @id @default(autoincrement())
  videoId       Int      @map("video_id")
  bountyId      Int      @map("bounty_id")
  creatorId     String   @map("creator_id")
  milestoneId   Int      @map("milestone_id")
  viewsAtClaim  BigInt   @map("views_at_claim")
  rewardAmount  Decimal  @db.Decimal(18, 6) @map("reward_amount")
  platformFee   Decimal  @db.Decimal(18, 6) @map("platform_fee")
  txHash        String   @map("tx_hash")
  blockNumber   BigInt?  @map("block_number")
  claimedAt     DateTime @default(now()) @map("claimed_at")
  
  video     Video     @relation(fields: [videoId], references: [id])
  bounty    Bounty    @relation(fields: [bountyId], references: [id])
  creator   User      @relation(fields: [creatorId], references: [id])
  milestone Milestone @relation(fields: [milestoneId], references: [id])
  
  @@unique([videoId, milestoneId])
  @@index([bountyId])
  @@index([creatorId])
  @@map("milestone_claims")
}

model EmailVerification {
  id         Int       @id @default(autoincrement())
  userId     String    @map("user_id")
  tokenHash  String    @unique @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("email_verifications")
}
